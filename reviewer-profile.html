<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reviewer Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="styles/main.css">
        <link rel="stylesheet" href="styles/cards.css">
        <link rel="stylesheet" href="styles/navigation.css">
        <link rel="stylesheet" href="styles/auth.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>MediaReview</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="./Movies/movies.html" class="nav-link">Movies</a></li>
                <li class="nav-item"><a href="#tv" class="nav-link" data-category="tv">TV Shows</a></li>
                <li class="nav-item"><a href="#music" class="nav-link" data-category="music">Music</a></li>
                <li class="nav-item"><a href="#games" class="nav-link" data-category="games">Games</a></li>
                <li class="nav-item"><a href="#books" class="nav-link" data-category="books">Books</a></li>
                <li class="nav-item"><a href="./Reviewers.html" class="nav-link">Reviewers</a></li>
            </ul>
            <div class="auth-buttons">
                <button class="btn btn-login" id="loginBtn">Login</button>
                <button class="btn btn-register" id="registerBtn">Register</button>
                <button class="btn btn-profile" id="profileBtn" style="display:none;">Profile</button>
                <button class="btn btn-logout" id="logoutBtn" style="display:none;">Logout</button>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>
    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>Discover & Review Your Favorite Media</h1>
            <p>Share your thoughts on movies, TV shows, music, games, and books. Join our community of reviewers!</p>
        </div>
    </section>
    <!-- Reviewer Profile Section -->
    <section class="popular-content" style="padding-top:0;">
        <div class="container" style="max-width:900px; margin:auto;">
              <h2 style="margin-top:32px;">Reviewer Profile</h2>
              <div class="profile-container" style="padding-top:90px;">
            <div class="profile-container">
        <div class="profile-header">
            <img id="profileAvatar" class="profile-avatar" src="" alt="Reviewer Avatar">
            <div class="profile-info">
                <div id="profileName" class="profile-name"></div>
                <div id="profileGenres" class="profile-genres"></div>
                <div id="profileEmail" class="profile-email"></div>
            </div>
        </div>
        <div class="reviews-section">
            <h2 style="margin-bottom:18px;color:#1976d2;">Reviews</h2>
            <ul id="userReviews" style="list-style:none;padding:0;margin:0;"></ul>
        </div>
    </div>
    <script type="module" src="scripts/cards.js"></script>
    <script type="module">
            // Import media arrays for lookup
            import { tv } from "./TV Shows/tv.js";
            import { music } from "./Music/music.js";
            import { games } from "./Video Games/games.js";
            import { books } from "./Books/books.js";
        // Get reviewerId from URL
        function getReviewerId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }
        const reviewerId = getReviewerId();
        // Fetch reviewer info from Realtime Database
        async function fetchReviewerInfo() {
            const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js');
            const appModule = await import('./scripts/firebase.js');
            const dbInstance = getDatabase(appModule.app);
            const snapshot = await get(ref(dbInstance, 'reviewers/' + reviewerId));
            if (snapshot.exists()) {
                const reviewer = snapshot.val();
                document.getElementById('profileAvatar').src = reviewer.avatar || 'https://randomuser.me/api/portraits/lego/1.jpg';
                document.getElementById('profileName').textContent = reviewer.name;
                document.getElementById('profileGenres').textContent = 'Genres: ' + reviewer.genres;
                document.getElementById('profileEmail').textContent = reviewer.email;
            }
        }
        // Fetch reviews from Firestore
        async function fetchReviewerReviews() {
            const { ref, get } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js');
            const appModule = await import('./scripts/firebase.js');
            const db = appModule.db;
            const reviewsRef = ref(db, 'reviews');
            const snapshot = await get(reviewsRef);
            const reviewsList = document.getElementById('userReviews');
            reviewsList.innerHTML = '';
            let hasReviews = false;
                if (snapshot.exists()) {
                    const reviewsData = snapshot.val();
                    // Build media map for lookup
                    let movies = [];
                    try {
                        movies = await (await fetch('Movies/movieList.json')).json();
                    } catch {
                        try {
                            movies = await (await fetch('../Movies/movieList.json')).json();
                        } catch {}
                    }
                    // Use imported arrays
                    const tvArr = Array.isArray(tv) ? tv : [];
                    const musicArr = Array.isArray(music) ? music : [];
                    const gamesArr = Array.isArray(games) ? games : [];
                    const booksArr = Array.isArray(books) ? books : [];
                    function getAllMediaMap(movies, tv, music, games, books) {
                        const all = [...movies, ...tv, ...music, ...games, ...books];
                        const map = {};
                        all.forEach(item => {
                            if (item.title) {
                                const normTitle = item.title.trim().toLowerCase();
                                const key = normTitle.replace(/[^a-zA-Z0-9]/g, '_');
                                map[key] = item;
                            }
                        });
                        return map;
                    }
                    const mediaMap = getAllMediaMap(movies, tvArr, musicArr, gamesArr, booksArr);
                    Object.entries(reviewsData).forEach(([mediaKey, reviewObj]) => {
                        Object.values(reviewObj).forEach(review => {
                            if (review.userId === reviewerId) {
                                hasReviews = true;
                                const li = document.createElement('li');
                                li.className = 'review-card';
                                li.style.marginBottom = '18px';
                                // Format title
                                const mediaItem = mediaMap[mediaKey];
                                let rawTitle = mediaItem ? mediaItem.title : mediaKey;
                                let title = rawTitle.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                                // Create clickable span for title
                                const titleSpan = document.createElement('span');
                                titleSpan.textContent = title;
                                titleSpan.style.color = '#1976d2';
                                titleSpan.style.cursor = 'pointer';
                                titleSpan.style.textDecoration = 'underline';
                                titleSpan.onclick = function(e) {
                                    e.stopPropagation();
                                    if (mediaItem && window.showItemDetails) {
                                        window.showItemDetails(mediaItem);
                                    } else if (window.showItemDetails) {
                                        window.showItemDetails({ title, id: mediaKey });
                                    } else {
                                        alert('Media details not found for this review.');
                                    }
                                };
                                li.appendChild(titleSpan);
                                li.appendChild(document.createTextNode(`: ${review.reviewText || ''}`));
                                // Add rating
                                if (review.rating !== undefined) {
                                    const ratingSpan = document.createElement('span');
                                    ratingSpan.textContent = ` (Rating: ${review.rating})`;
                                    ratingSpan.style.marginLeft = '8px';
                                    li.appendChild(ratingSpan);
                                }
                                reviewsList.appendChild(li);
                            }
                        });
                    });
                }
            if (!hasReviews) {
                reviewsList.innerHTML = '<li>No reviews yet.</li>';
            }
        }
        // Initial load
        if (reviewerId) {
            fetchReviewerInfo();
            fetchReviewerReviews();
        } else {
            document.querySelector('.profile-container').innerHTML = '<p>Reviewer not found.</p>';
        }
    </script>
</body>
</html>
